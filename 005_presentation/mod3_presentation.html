<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Advances in the analysis of multivariate ecological data</title>
    <meta charset="utf-8" />
    <meta name="author" content="Jonathan Jupke" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="libs\sydney.css" type="text/css" />
    <link rel="stylesheet" href="libs\sydney-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Advances in the analysis of multivariate ecological data
## MOD3: Advanced data science
### Jonathan Jupke
### University of Koblenz Landau
### 2021/01/07

---

&lt;style type="text/css"&gt;
.remark-code { font-family: 'Source Code Pro', 'Lucida Console', Monaco, monospace;
                                    font-size: 100%;
                                  }
}
&lt;/style&gt;






&lt;!--TODO abstand zwischen Bullets--&gt;  
&lt;!--# TODO serial slide--&gt;   
&lt;!--# TODO bullet color--&gt;  

# Plan for today 

- What’s new in multivariate analysis?

- mvabund

- Vector GLM/GAM

- Latent Variable Models 

- Copulas 

- Hierarchical Modeling of Species Communities

- Neural Hierarchical Models 


---
class: inverse, center, middle 

# What’s new in multivariate analysis?

---

# ... or what's old

--

brainstrom : What Methods do you know? 

--

- PCA
- RDA
- PERMANOVA
- CA/ CCA
- Random Forests 
- Clustering Methods 

---
# Bi/Triplot


```r
library(vegan)
data(dune)
data(dune.env)
rda_object &lt;- rda(dune ~ ., dune.env)
```

---
# Bi/Triplot

```r
plot(rda_object)
```

&lt;img src="mod3_presentation_files/figure-html/unnamed-chunk-2-1.png" style="display: block; margin: auto;" /&gt;

---
# What do most ordinations have in common? 

--

They are based on some notion of a distance metric

##fixed 
- PCA and RDA: Euclidean 
- CA and CCA: `\(\chi^2\)`-distance

--

##flexible 
- NMDS 
- PCoA
- dbRDA

---
# How does that differ from the univerate and why? 

--

In univariate analyses we mostly use models:
- linear model 
- linear mixed model 
- generalized linear model 
- generalized additive models 

--

`\(\rightarrow\)` why not in multivariate analyses? 

---
class: middle, center

&lt;img src="old_pc.gif" style="display: block; margin: auto;" /&gt;

---
# The idea is old 

The Gaussian response model: 
$$Y_i = ce^{- \frac{(X_i - u)^2}{2t^2}} $$
--
Can be rewritten as a GLM:
`$$Y_i = exp(ln(c) - \frac{u^2}{2t^2} + \frac{u}{t^2}x_i - \frac{1}{2t^2}x^2_i) = exp(b_1 + b_2 x_i + b_3 x_i^2)$$`
--
with 
$$ t = \frac{1}{\sqrt{-2b_3}}; u = \frac{-b_2}{2b_3}; c =     exp(b_1 - \frac{b_2^2}{4b_3})$$ 
--
For M species and Q environmental variables we would need: `\((1+2Q)M\)` parameters. For 10 species and 5 variables 110 parameters.  

---
# Restricted Gaussian Regression 

gradients as linear combinations of measured variables: 

`$$z_i = \Sigma_{p =  1}^Q \alpha_p x_{ip}$$`
--
Plug gradients back into Gaussian regression
`$$Y_i = ce ^{\frac{(z_i - u)^2}{2t^2}}$$` 

Depending on the number of gradients this reduces the number of parameters. 

---
# What is the model-based approach? 

Model-based approaches assume a parametric generative model

Terms are not consistent:  
Roberts (2019) vs. Warton *el al.* (2012) dissagree about wether CA is distance-based

Alternative: algorithm-based (Warton *et al.* 2015) 
Alternative 2: transformation-based  

"*Our constrained ordination model [...]* " Brittain *et al.* (2020)  
"*Many biologist fit CCA models [...]* " Yee (2004) 

---
background-image: url("figures/glm_error.png")
background-size: 500px
background-position: 50% 50%
&lt;!-- Are models better  1--&gt;
# Are models better? 

---
background-image: url("figures/WWW12_1.png")
background-size: 800px
background-position: 50% 50%
&lt;!-- Are models better  2--&gt;
# Are models better? 

Every distance metric assumes a mean variance relationship  

.footnote[Warton *et al.* (2012)]
---
background-image: url("figures/WWW12_2.png")
background-size: 400px
background-position: 50% 75%

# Are models better? 

Every distance metric assumes a mean variance relationship  



.footnote[Warton *et al.* (2012)]
---
background-image: url("figures/WWW12_3.png")
background-size: 400px
background-position: 50% 75%

# Are models better? 

Every distance metric assumes a mean variance relationship  



.footnote[Warton *et al.* (2012)]
---
background-image: url("figures/szöcs15_1.png")
background-size: 400px
background-position: 50% 75%

# Are models better? 



.footnote[Szöcs *et al.* (2015)]
---
background-image: url("figures/jupke20_1.png")
background-size: 800px
background-position: 50% 50%

# Are models better? 

.footnote[Jupke *et al.* (2020)]
---
class: inverse, center, middle 

# mvabund

---
# mvabund 

R package published in 2012  (Wang et al. 2012)

**M**ulti**v**ariate **Abund**ance data  

Multivariate
- many, possibly correlated responses 

Abundance
- strong mean-variance relationship 
---
# Multivariate GLMM

We could use mixed models and model the taxon as a random effect.
`$$Abundace \sim species\ + variable1\ + variable2\ + (0 + species|sample)$$`
1. `\(y_{ij}\)` are independand, conditional on mean  `\(\mu_{ij}\)`
2. Conditional on `\(\mu_{ij}\)`, data come from a .blue[known distribution]  
3. straight line relationship between some function `\(\mu_{ij}\)` and x, with error `\(\epsilon_{ij}\)`
`$$g(\mu_{ij}) = \beta_0j + x^T_j \beta_j + \epsilon_{ij}$$`
4. `\(\epsilon\)` are normally distributed. They introduce correlation between response within observatios. 
`$$\epsilon_{ij} \sim MVN(0, \Sigma)$$`
---
# Implementations in R

- lme4 
- MCMCglmm 
- Purpose written code (e.g. Pollock et al 2014)

---
# Whats the problem with this approach? 

|  # responses | # parameters in `\(\Sigma\)` |
| :---- |:--- |
| 5     | 15 |
| 10    | 55 |
| 20    | 210 |
| 40    |  820 |

- No convergence in ML GLMM  
- long run time, not all parameters converge, and big influence of prior as `\(\frac{\# data}{\#parameters}\)` is small. 
  
---
# Simplify
mvabund uses design-based inference and assumes simple correlation structures.  
This is fine if we are primarily interested in species environment relationships  

--
Multivariate: row resampling for inference, preserves species correlations  
Abundance: separate GLM for each species
---
# Test statistics  

default: `\(\Sigma\ Likelihood\ Ratios\)`
`\begin{align}
L &amp; = 2 \times (l_M - l_m)  \\
L &amp;\sim \chi^2_{p_M - p_m} \\  
\end{align}`

This does not account for correlations in the statistic but in the pseudo-*p*-value.  
--
  
  
Alternatives:      
  
Wald statistic   
`\begin{align}
W &amp;= \frac{(\beta_m - \beta_0)^2}{var(\beta_m)} \\
z &amp;= \sqrt(W)
\end{align}`

Score statistic  
see e.g. Dunn \&amp; Smyth (2018)

---
# Correlation options
  
.blue["I"]: No correlation, default setting   
.blue["R"]: Assumes correlation, cf. mixed model  
.blue["shrink"]: middle option, shrinks correlation matrix to `\(I\)` with ridge regularization (Warton (2008))  
  
For R and shrink LR is not available. They are estimated with generalized estimation equations (Warton 2011) which do not produce likelihoods. 

---


```r
library(mvabund)
data("Tasmania")
attach(Tasmania)
head(copepods[,1:3])
```

```
##      Ameira Adopsyllus Ectinosoma
## B1D1     43          0          0
## B1D2     63          0          0
## B1U1    124          0          0
## B1U2    105          0          2
## B2D1      4          0          0
## B2D2      5          0          0
```

```r
tasmvabund &lt;- mvabund(copepods)
class(tasmvabund)
```

```
## [1] "mvabund" "matrix"
```
---

```r
plot(tasmvabund~treatment, col = as.numeric(block))
```

```
## 
##  PIPING TO 2nd MVFACTOR
```

&lt;img src="mod3_presentation_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;
---

```r
meanvar.plot(copepods~tr.block, col = as.numeric (treatment))
```

```
## START SECTION 2 
## Plotting if overlay is TRUE
```

&lt;img src="mod3_presentation_files/figure-html/unnamed-chunk-7-1.png" style="display: block; margin: auto;" /&gt;

```
## FINISHED SECTION 2
```
---
# Fitting a model 

```r
tas.nb &lt;- manyglm(copepods ~ block*treatment, 
                  family = "negative.binomial")
```


`$$Y_{ij} \sim NB(\mu_{jkl}, \phi_j)$$`
`$$log(\mu_{jkl}) = intercept_j + block_{jkl} + treatment_{jl} + block \times treatment_{jkl}$$`
---
# Checking model assumptions 

```r
plot.manyglm(tas.nb, which = 1)
```

&lt;img src="mod3_presentation_files/figure-html/mvabund Checking model assumptions 1-1.png" style="display: block; margin: auto;" /&gt;
.footnote[Dunn &amp; Smyth (1996)]
---
# Checking model assumptions

```r
plot.manyglm(tas.nb, which = 2)
```

&lt;img src="mod3_presentation_files/figure-html/mvabund Checking model assumptions 2-1.png" style="display: block; margin: auto;" /&gt;
.footnote[Dunn &amp; Smyth (1996)]
---
# Checking model assumptions

```r
plot.manyglm(tas.nb, which = 3)
```

&lt;img src="mod3_presentation_files/figure-html/mvabund Checking model assumptions 3-1.png" style="display: block; margin: auto;" /&gt;
.footnote[Dunn &amp; Smyth (1996)]
---
# Testing Hypotheses


```r
# anova_out &lt;- anova(tas.nb, p.uni = "adjusted")
```
.scroll-box-16[

```r
# anova_out
```
]
---

```r
library(lattice)
a &lt;- max(abs(coef(tas.nb)))
colort &lt;- colorRampPalette(c("blue", "white", "red"))
plot.tas &lt;- levelplot(t(as.matrix(coef(tas.nb))), ylab = "", xlab  = "", col.regions = colort(100), at=seq(-a,a,length = 100), scales = list( x= list(rot = 45)))
print(plot.tas)
```

![](mod3_presentation_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;
---

```r
tas_pred = predict(tas.nb, type = "response")
matplot(t(tas_pred[c(1,3),]), type = "l", xaxt = "n", log = "y", ylab = "Mean abundance [log]")
axis(1, at =1:12, labels = colnames(copepods), las = 3)
legend("topright", legend = levels(treatment), col = 1:2, lty = 1:2)
```

![](mod3_presentation_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;


---
# Traits 
Not discussed in lecture. See here for introduction:  
https://rpubs.com/dwarton/68823

---
class: inverse, center, middle 

# Vector Genralized Models 

---

```r
library(VGAM)
```


```r
data(spider)
knitr::kable(head(spider$abund[,1:5]), format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; Alopacce &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Alopcune &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Alopfabr &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Arctlute &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Arctperi &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 25 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 15 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
.scroll-output[

```r
set.seed(1234)
p1ut.hs &lt;- cqo(
  cbind(
    Alopacce, Alopcune, Alopfabr, Arctlute, Arctperi,
    Auloalbi, Pardlugu, Pardmont, Pardnigr, Pardpull,
    Trocterr, Zoraspin) ~ WaterCon + BareSand + 
    FallTwig + CoveMoss + CoveHerb + ReflLux,
    family = poissonff, data = hspider, eq.toler = FALSE, trace = FALSE)
```

```
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
## cqo_1; no convergence for Species number   5. Trying internal starting values.
```

```r
S &lt;- ncol(depvar(p1ut.hs)) # Number of species
clr &lt;- (1:(S+1))[-7] # Omits yellow
lvplot(p1ut.hs, y = TRUE, lcol = clr, pch = 1:S, pcol = clr)
```

![](mod3_presentation_files/figure-html/run cqo-1.png)&lt;!-- --&gt;
]
---

```r
persp(p1ut.hs, col = clr, label = TRUE) # Perspective plot
```

![](mod3_presentation_files/figure-html/cqo persp plot-1.png)&lt;!-- --&gt;

---
# Predictors 

```r
round(concoef(p1ut.hs), digits = 2)
```

```
##          latvar
## WaterCon   0.29
## BareSand  -0.32
## FallTwig   0.29
## CoveMoss  -0.14
## CoveHerb   0.27
## ReflLux   -0.52
```
---

.small[

```r
p2et.hs &lt;- cqo(cbind(Alopacce, Alopcune, Alopfabr, Arctlute, Arctperi,Auloalbi, Pardlugu, Pardmont, Pardnigr, Pardpull,Trocterr, Zoraspin)
               ~ WaterCon + BareSand + FallTwig + CoveMoss + CoveHerb + ReflLux,
               poissonff, data = hspider, Crow1positive = FALSE, Rank = 2,
               I.toler = TRUE, Bestof = 2)
```

```
## Warning in cqo.fitter(x = x, y = y, w = w, offset = offset, etastart =
## etastart, : I.tolerances = TRUE but the variables making up the latent
## variable(s) do not appear to be centered.
```

```
## Warning in fn(par, ...): error code in callcqoc = 3

## Warning in fn(par, ...): error code in callcqoc = 3

## Warning in fn(par, ...): error code in callcqoc = 3

## Warning in fn(par, ...): error code in callcqoc = 3

## Warning in fn(par, ...): error code in callcqoc = 3
```

```
## Warning in checkwz(wz, M = M, trace = trace, wzeps = control$wzepsilon): 3
## diagonal elements of the working weights variable 'wz' have been replaced by
## 1.819e-12
```

```
## Warning in cqo.fitter(x = x, y = y, w = w, offset = offset, etastart =
## etastart, : I.tolerances = TRUE but the variables making up the latent
## variable(s) do not appear to be centered.
```
]
---


```r
persp(p2et.hs, xlim = c(-6, 5), ylim = c(-6, 3), theta = 120, phi = 20)
```

![](mod3_presentation_files/figure-html/cqo 2d persp-1.png)&lt;!-- --&gt;

---
class: inverse, center, middle 

# Latent Variable Models 

---
class: inverse, center, middle 

# Copulas 

---
class: inverse, center, middle 

# Hierarchical modeling of species communities 

---
class: inverse, center, middle 

# Hierarchical Neural networks 

---
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
